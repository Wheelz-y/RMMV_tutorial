//=============================================================================
// Decrypter.js
//=============================================================================
/*:
 * @plugindesc 仿mv加密
 * @author wangwang
 *
 * @param Decrypter
 * @desc 仿mv加密解密
 * @default 1.0 
 * 
 * @param dir
 * @desc 保存位置
 * @default encrypt/
 * 
 * @param encryptList
 * @desc 加密列表,如 : ["img","data","audio","js","js/plugins"]
 * @default   ["img","audio","data"]
 * 
 * @param encryptExt
 * @desc 加密种类
 * @default   { "ogg": "rmo", "m4a": "rmm", "png": "rmp", "js": "rmj", "json": "rmd" }
 * 
 * @param encryptType
 * @desc 加密种类
 * @default   { "ogg": "b", "m4a": "b", "png": "b", "js": "t", "json": "t" }
 * 
 * @param plugins
 * @desc 加密插件组
 * @default  
 * 
 * @param ignoreList
 * @desc 忽略列表
 * @default []
 *  
 * 
 *
 * @help 
 * 
 * 
 *
 */var MD5=function(a){function g(a,d){var c,e,b,f;b=a&2147483648;f=d&2147483648;c=a&1073741824;e=d&1073741824;a=(a&1073741823)+(d&1073741823);return c&e?a^2147483648^b^f:c|e?a&1073741824?a^3221225472^b^f:a^1073741824^b^f:a^b^f}function h(a,b,f,d,c,e,h){a=g(a,g(g(b&f|~b&d,c),h));return g(a<<e|a>>>32-e,b)}function k(a,b,f,d,e,c,h){a=g(a,g(g(b&d|f&~d,e),h));return g(a<<c|a>>>32-c,b)}function m(a,b,d,f,c,e,h){a=g(a,g(g(b^d^f,c),h));return g(a<<e|a>>>32-e,b)}function l(a,b,d,e,f,c,h){a=g(a,g(g(d^(b|~e),f),h));return g(a<<c|a>>>32-c,b)}function n(a){var b="",d,c;for(c=0;3>=c;c++)d=a>>>8*c&255,d="0"+d.toString(16),b+=d.substr(d.length-2,2);return b}var d=[],p,q,r,t,c,e,b,f;a=function(a){a=a.replace(/\r\n/g,"\n");for(var b="",d=0;d<a.length;d++){var c=a.charCodeAt(d);128>c?b+=String.fromCharCode(c):(127<c&&2048>c?b+=String.fromCharCode(c>>6|192):(b+=String.fromCharCode(c>>12|224),b+=String.fromCharCode(c>>6&63|128)),b+=String.fromCharCode(c&63|128))}return b}(a);d=function(a){var b,c=a.length;b=c+8;for(var d=16*((b-b%64)/64+1),e=Array(d-1),f,g=0;g<c;)b=(g-g%4)/4,f=g%4*8,e[b]|=a.charCodeAt(g)<<f,g++;e[(g-g%4)/4]|=128<<g%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(a);c=1732584193;e=4023233417;b=2562383102;f=271733878;for(a=0;a<d.length;a+=16)p=c,q=e,r=b,t=f,c=h(c,e,b,f,d[a+0],7,3614090360),f=h(f,c,e,b,d[a+1],12,3905402710),b=h(b,f,c,e,d[a+2],17,606105819),e=h(e,b,f,c,d[a+3],22,3250441966),c=h(c,e,b,f,d[a+4],7,4118548399),f=h(f,c,e,b,d[a+5],12,1200080426),b=h(b,f,c,e,d[a+6],17,2821735955),e=h(e,b,f,c,d[a+7],22,4249261313),c=h(c,e,b,f,d[a+8],7,1770035416),f=h(f,c,e,b,d[a+9],12,2336552879),b=h(b,f,c,e,d[a+10],17,4294925233),e=h(e,b,f,c,d[a+11],22,2304563134),c=h(c,e,b,f,d[a+12],7,1804603682),f=h(f,c,e,b,d[a+13],12,4254626195),b=h(b,f,c,e,d[a+14],17,2792965006),e=h(e,b,f,c,d[a+15],22,1236535329),c=k(c,e,b,f,d[a+1],5,4129170786),f=k(f,c,e,b,d[a+6],9,3225465664),b=k(b,f,c,e,d[a+11],14,643717713),e=k(e,b,f,c,d[a+0],20,3921069994),c=k(c,e,b,f,d[a+5],5,3593408605),f=k(f,c,e,b,d[a+10],9,38016083),b=k(b,f,c,e,d[a+15],14,3634488961),e=k(e,b,f,c,d[a+4],20,3889429448),c=k(c,e,b,f,d[a+9],5,568446438),f=k(f,c,e,b,d[a+14],9,3275163606),b=k(b,f,c,e,d[a+3],14,4107603335),e=k(e,b,f,c,d[a+8],20,1163531501),c=k(c,e,b,f,d[a+13],5,2850285829),f=k(f,c,e,b,d[a+2],9,4243563512),b=k(b,f,c,e,d[a+7],14,1735328473),e=k(e,b,f,c,d[a+12],20,2368359562),c=m(c,e,b,f,d[a+5],4,4294588738),f=m(f,c,e,b,d[a+8],11,2272392833),b=m(b,f,c,e,d[a+11],16,1839030562),e=m(e,b,f,c,d[a+14],23,4259657740),c=m(c,e,b,f,d[a+1],4,2763975236),f=m(f,c,e,b,d[a+4],11,1272893353),b=m(b,f,c,e,d[a+7],16,4139469664),e=m(e,b,f,c,d[a+10],23,3200236656),c=m(c,e,b,f,d[a+13],4,681279174),f=m(f,c,e,b,d[a+0],11,3936430074),b=m(b,f,c,e,d[a+3],16,3572445317),e=m(e,b,f,c,d[a+6],23,76029189),c=m(c,e,b,f,d[a+9],4,3654602809),f=m(f,c,e,b,d[a+12],11,3873151461),b=m(b,f,c,e,d[a+15],16,530742520),e=m(e,b,f,c,d[a+2],23,3299628645),c=l(c,e,b,f,d[a+0],6,4096336452),f=l(f,c,e,b,d[a+7],10,1126891415),b=l(b,f,c,e,d[a+14],15,2878612391),e=l(e,b,f,c,d[a+5],21,4237533241),c=l(c,e,b,f,d[a+12],6,1700485571),f=l(f,c,e,b,d[a+3],10,2399980690),b=l(b,f,c,e,d[a+10],15,4293915773),e=l(e,b,f,c,d[a+1],21,2240044497),c=l(c,e,b,f,d[a+8],6,1873313359),f=l(f,c,e,b,d[a+15],10,4264355552),b=l(b,f,c,e,d[a+6],15,2734768916),e=l(e,b,f,c,d[a+13],21,1309151649),c=l(c,e,b,f,d[a+4],6,4149444226),f=l(f,c,e,b,d[a+11],10,3174756917),b=l(b,f,c,e,d[a+2],15,718787259),e=l(e,b,f,c,d[a+9],21,3951481745),c=g(c,p),e=g(e,q),b=g(b,r),f=g(f,t);return(n(c)+n(e)+n(b)+n(f)).toUpperCase()},MD5_2=function(a){try{return require("crypto").createHash("md5").update(a).digest("hex").toUpperCase()}catch(g){return"D41D8CD98F00B204E9800998ECF8427E"}};DataManager.loadDataFile=function(a,g){var h=new XMLHttpRequest,k="data/"+g;Decrypter.hasEncryptedData&&!Decrypter.checkImgIgnore(k)?(k=Decrypter.extToEncryptExt(k),h.open("GET",k),h.responseType="arraybuffer",h.onload=function(){400>h.status&&(window[a]=JSON.parse(Decrypter.decryptText(h.response)),DataManager.onLoad(window[a]))}):(h.open("GET",k),h.overrideMimeType("application/json"),h.onload=function(){400>h.status&&(window[a]=JSON.parse(h.responseText),DataManager.onLoad(window[a]))});h.onerror=function(){DataManager._errorUrl=DataManager._errorUrl||k};window[a]=null;h.send()};DataManager.onLoad=function(a){var g;a===$dataMap?(this.extractMetadata(a),g=a.events):g=a;if(Array.isArray(g))for(var h=0;h<g.length;h++){var k=g[h];k&&void 0!==k.note&&this.extractMetadata(k)}a===$dataSystem&&Scene_Boot.loadSystemImages()};Graphics._playVideo=function(a){if(Decrypter.hasEncryptedVideo&&!Decrypter.checkImgIgnore(a)){var g=new XMLHttpRequest;g.open("GET",a);g.responseType="arraybuffer";g.send();g.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(g.response),a=Decrypter.createBlobUrl(a);Graphics._playVideo2(a)}}}else this._playVideo2(url)};Graphics._playVideo2=function(a){this._video.onloadeddata=this._onVideoLoad.bind(this);this._video.onerror=this._videoLoader;this._video.onended=this._onVideoEnd.bind(this);this._videoLoading=!0;this._video.src=a;this._video.load()};PluginManager._loadScriptEnd=[];PluginManager.loadScriptEnd=function(a,g){for(var h=function(a){try{if(null!=a.response){var d=document.createElement("script");d.language="javascript";d.type="text/javascript";d.id=a.url;d.defer=!0;try{d.appendChild(document.createTextNode(a.response))}catch(p){d.text=a.response}document.body.appendChild(d)}}catch(p){eval(a.response)}return!0},k=1,m=0;m<this._loadScriptEnd.length;m++){var l=this._loadScriptEnd[m];l.url!=a||l.response||(l.response=g);l.response?k&&!0!==l.response&&h(l)&&(l.response=!0):k=0}};PluginManager.loadScript2=function(a,g){if(Decrypter.hasEncryptedJS){var h=new XMLHttpRequest,k=g?"js/"+a:PluginManager._path+a;a=k;Decrypter.checkImgIgnore(k)?(h.overrideMimeType("application/json"),h.onload=function(){400>h.status&&PluginManager.loadScriptEnd(k,h.responseText)}):(a=Decrypter.extToEncryptExt(k),h.responseType="arraybuffer",h.onload=function(){400>h.status&&PluginManager.loadScriptEnd(k,Decrypter.decryptText(h.response))});h.onerror=function(){DataManager._errorUrl=DataManager._errorUrl||k};this._loadScriptEnd.push({url:k,response:!1});h.open("GET",a);h.send()}};PluginManager.setup2=function(a){a.forEach(function(a){a.status&&!this._scripts.contains(a.name)&&(this.setParameters(a.name,a.parameters),this.loadScript2(a.name+".js"),this._scripts.push(a.name))},this)};PluginManager.start=function(){Decrypter._plugins&&PluginManager.loadScript2(Decrypter._plugins)};Decrypter.decryptArrayBuffer=function(a){return this.decrypt(a,0,"b")};Decrypter.decryptText=function(a){return this.decrypt(a,1,"t")};Decrypter.decryptImg=function(a,g){a=this.extToEncryptExt(a);var h=new XMLHttpRequest;h.open("GET",a);h.responseType="arraybuffer";h.send();h.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(h.response);g._image.src=Decrypter.createBlobUrl(a);g._image.addEventListener("load",g._loadListener=Bitmap.prototype._onLoad.bind(g));g._image.addEventListener("error",g._errorListener=g._loader||Bitmap.prototype._onError.bind(g))}};h.onerror=function(){g._loader?g._loader():g._onError()}};Decrypter.decryptHTML5Audio=function(a,g,h){var k=new XMLHttpRequest;k.open("GET",a);k.responseType="arraybuffer";k.send();k.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(k.response),a=Decrypter.createBlobUrl(a);AudioManager.createDecryptBuffer(a,g,h)}}};Decrypter.createBlobUrl=function(a){a=new Blob([a]);return window.URL.createObjectURL(a)};Decrypter.listname=function(){return this._listname};Decrypter.localURL=function(){if(!this._localURL){var a=window.location.pathname.replace(/(\/www|)\/[^\/]*$/,"");a.match(/^\/([A-Z]\:)/)&&(a=a.slice(1));this._localURL=decodeURIComponent(a)}return this._localURL};Decrypter._dirs={};Decrypter.localFileName=function(a){if(a){a=a.split("/");for(var g=this.localURL(),h=require("fs"),k="",m=0;m<a.length-1;m++){var k=k+"/"+a[m],l=g+k;this._dirs[k]||(h.existsSync(l)||h.mkdirSync(l),this._dirs[k]=1)}k=k+"/"+a[m];return g+k}};Decrypter.webURL=function(){return this._webURL||""};Decrypter.webFileName=function(a){return this.webURL()+"/"+a};Decrypter.checkImgIgnore=function(a){for(var g=0;g<this._ignoreList.length;g++)if(a===this._ignoreList[g])return!0;return!1};Decrypter._extToEncryptExt={};Decrypter.extToEncryptExt=function(a,g){g=(g?"1":"0")+a;if(!this._extToEncryptExt[g]){var h="0"+a,k="1"+a,m=a.split(".").pop(),l=".";m!==a&&(l=this._encryptExt[m]?l+this._encryptExt[m]:l+m,a=a.slice(0,a.lastIndexOf(m)-1)+l);this._extToEncryptExt[k]=this.webFileName(this._dir+a);this._extToEncryptExt[h]=this.localFileName(this._dir+a)}return this._extToEncryptExt[g]};(function(){var a=function(a,g,h){try{var k=a[g]}catch(d){k=h}return void 0===k?h:k},g=function(g,h,l){var k;g=a(g,h);try{k=JSON.parse(g)}catch(d){k=g}return k||l},h=function(a){a=a||"";var g=a.toLowerCase(),h=PluginManager._parameters[g];if(!h){var k=PluginManager._parameters,d;for(d in k)if(k[d]&&a in k[d]){h=k[d];break}k=$plugins;for(d=0;d<k.length;d++)if(k[d]&&(g=k[d].parameters)&&a in g){h=g;break}}return h||{}}("Decrypter");Decrypter._dir=a(h,"dir");Decrypter._webURL=a(h,"weburl");Decrypter._listname=a(h,"listname");Decrypter._plugins=a(h,"plugins");Decrypter._ignoreList=g(h,"ignoreList",[]);Decrypter._encryptExt=g(h,"encryptExt",{});Decrypter._encryptType=g(h,"encryptType",{});g=Decrypter._encryptList=g(h,"encryptList",{});Decrypter.hasEncryptedData=g.contains("data");Decrypter.hasEncryptedImages=g.contains("img");Decrypter.hasEncryptedAudio=g.contains("audio");Decrypter.hasEncryptedJS=g.contains("js")||g.contains("js/plugins");Decrypter.hasEncryptedVideo=g.contains("movies");try{PluginManager.start()}catch(k){}})();