//=============================================================================
// Decrypter.js
//=============================================================================
/*:
 * @plugindesc 仿mv加密
 * @author wangwang
 *
 * @param Decrypter
 * @desc 仿mv加密解密
 * @default 1.0 
 * 
 * @param dir
 * @desc 保存位置
 * @default encrypt/
 * 
 * @param encryptList
 * @desc 加密列表,如 : ["img","data","audio","js","js/plugins"]
 * @default   ["img","audio","data"]
 * 
 * @param encryptExt
 * @desc 加密种类
 * @default   { "ogg": "rmo", "m4a": "rmm", "png": "rmp", "js": "rmj", "json": "rmd" }
 * 
 * @param encryptType
 * @desc 加密种类
 * @default   { "ogg": "b", "m4a": "b", "png": "b", "js": "t", "json": "t" }
 * 
 * @param plugins
 * @desc 加密插件组
 * @default  
 * 
 * @param ignoreList
 * @desc 忽略列表
 * @default []
 *  
 * 
 *
 * @help 
 * 
 * 
 *
 */
var MD5=function(a){function d(a,d){var c,g,b,f;b=a&2147483648;f=d&2147483648;c=a&1073741824;g=d&1073741824;a=(a&1073741823)+(d&1073741823);return c&g?a^2147483648^b^f:c|g?a&1073741824?a^3221225472^b^f:a^1073741824^b^f:a^b^f}function h(a,b,f,c,g,e,h){a=d(a,d(d(b&f|~b&c,g),h));return d(a<<e|a>>>32-e,b)}function k(a,b,f,c,g,e,h){a=d(a,d(d(b&c|f&~c,g),h));return d(a<<e|a>>>32-e,b)}function m(a,b,c,f,g,e,h){a=d(a,d(d(b^c^f,g),h));return d(a<<e|a>>>32-e,b)}function l(a,b,c,f,g,e,h){a=d(a,d(d(c^(b|~f),g),h));return d(a<<e|a>>>32-e,b)}function n(a){var d="",b,c;for(c=0;3>=c;c++)b=a>>>8*c&255,b="0"+b.toString(16),d+=b.substr(b.length-2,2);return d}var c=[],p,q,r,t,g,b,f,e;a=function(a){a=a.replace(/\r\n/g,"\n");for(var d="",b=0;b<a.length;b++){var c=a.charCodeAt(b);128>c?d+=String.fromCharCode(c):(127<c&&2048>c?d+=String.fromCharCode(c>>6|192):(d+=String.fromCharCode(c>>12|224),d+=String.fromCharCode(c>>6&63|128)),d+=String.fromCharCode(c&63|128))}return d}(a);c=function(a){var d,b=a.length;d=b+8;for(var c=16*((d-d%64)/64+1),f=Array(c-1),g,e=0;e<b;)d=(e-e%4)/4,g=e%4*8,f[d]|=a.charCodeAt(e)<<g,e++;f[(e-e%4)/4]|=128<<e%4*8;f[c-2]=b<<3;f[c-1]=b>>>29;return f}(a);g=1732584193;b=4023233417;f=2562383102;e=271733878;for(a=0;a<c.length;a+=16)p=g,q=b,r=f,t=e,g=h(g,b,f,e,c[a+0],7,3614090360),e=h(e,g,b,f,c[a+1],12,3905402710),f=h(f,e,g,b,c[a+2],17,606105819),b=h(b,f,e,g,c[a+3],22,3250441966),g=h(g,b,f,e,c[a+4],7,4118548399),e=h(e,g,b,f,c[a+5],12,1200080426),f=h(f,e,g,b,c[a+6],17,2821735955),b=h(b,f,e,g,c[a+7],22,4249261313),g=h(g,b,f,e,c[a+8],7,1770035416),e=h(e,g,b,f,c[a+9],12,2336552879),f=h(f,e,g,b,c[a+10],17,4294925233),b=h(b,f,e,g,c[a+11],22,2304563134),g=h(g,b,f,e,c[a+12],7,1804603682),e=h(e,g,b,f,c[a+13],12,4254626195),f=h(f,e,g,b,c[a+14],17,2792965006),b=h(b,f,e,g,c[a+15],22,1236535329),g=k(g,b,f,e,c[a+1],5,4129170786),e=k(e,g,b,f,c[a+6],9,3225465664),f=k(f,e,g,b,c[a+11],14,643717713),b=k(b,f,e,g,c[a+0],20,3921069994),g=k(g,b,f,e,c[a+5],5,3593408605),e=k(e,g,b,f,c[a+10],9,38016083),f=k(f,e,g,b,c[a+15],14,3634488961),b=k(b,f,e,g,c[a+4],20,3889429448),g=k(g,b,f,e,c[a+9],5,568446438),e=k(e,g,b,f,c[a+14],9,3275163606),f=k(f,e,g,b,c[a+3],14,4107603335),b=k(b,f,e,g,c[a+8],20,1163531501),g=k(g,b,f,e,c[a+13],5,2850285829),e=k(e,g,b,f,c[a+2],9,4243563512),f=k(f,e,g,b,c[a+7],14,1735328473),b=k(b,f,e,g,c[a+12],20,2368359562),g=m(g,b,f,e,c[a+5],4,4294588738),e=m(e,g,b,f,c[a+8],11,2272392833),f=m(f,e,g,b,c[a+11],16,1839030562),b=m(b,f,e,g,c[a+14],23,4259657740),g=m(g,b,f,e,c[a+1],4,2763975236),e=m(e,g,b,f,c[a+4],11,1272893353),f=m(f,e,g,b,c[a+7],16,4139469664),b=m(b,f,e,g,c[a+10],23,3200236656),g=m(g,b,f,e,c[a+13],4,681279174),e=m(e,g,b,f,c[a+0],11,3936430074),f=m(f,e,g,b,c[a+3],16,3572445317),b=m(b,f,e,g,c[a+6],23,76029189),g=m(g,b,f,e,c[a+9],4,3654602809),e=m(e,g,b,f,c[a+12],11,3873151461),f=m(f,e,g,b,c[a+15],16,530742520),b=m(b,f,e,g,c[a+2],23,3299628645),g=l(g,b,f,e,c[a+0],6,4096336452),e=l(e,g,b,f,c[a+7],10,1126891415),f=l(f,e,g,b,c[a+14],15,2878612391),b=l(b,f,e,g,c[a+5],21,4237533241),g=l(g,b,f,e,c[a+12],6,1700485571),e=l(e,g,b,f,c[a+3],10,2399980690),f=l(f,e,g,b,c[a+10],15,4293915773),b=l(b,f,e,g,c[a+1],21,2240044497),g=l(g,b,f,e,c[a+8],6,1873313359),e=l(e,g,b,f,c[a+15],10,4264355552),f=l(f,e,g,b,c[a+6],15,2734768916),b=l(b,f,e,g,c[a+13],21,1309151649),g=l(g,b,f,e,c[a+4],6,4149444226),e=l(e,g,b,f,c[a+11],10,3174756917),f=l(f,e,g,b,c[a+2],15,718787259),b=l(b,f,e,g,c[a+9],21,3951481745),g=d(g,p),b=d(b,q),f=d(f,r),e=d(e,t);return(n(g)+n(b)+n(f)+n(e)).toUpperCase()},MD5_2=function(a){try{return require("crypto").createHash("md5").update(a).digest("hex").toUpperCase()}catch(d){return"D41D8CD98F00B204E9800998ECF8427E"}},Utf8={encode:function(a){a=a.replace(/[\u0080-\u07ff]/g,function(a){a=a.charCodeAt(0);return String.fromCharCode(192|a>>6,128|a&63)});return a=a.replace(/[\u0800-\uffff]/g,function(a){a=a.charCodeAt(0);return String.fromCharCode(224|a>>12,128|a>>6&63,128|a&63)})},decode:function(a){a=a.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(a){a=(a.charCodeAt(0)&15)<<12|(a.charCodeAt(1)&63)<<6|a.charCodeAt(2)&63;return String.fromCharCode(a)});return a=a.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(a){a=(a.charCodeAt(0)&31)<<6|a.charCodeAt(1)&63;return String.fromCharCode(a)})}};DataManager.loadDataFile=function(a,d){var h=new XMLHttpRequest,k="data/"+d;Decrypter.hasEncryptedData&&!Decrypter.checkImgIgnore(k)?(k=Decrypter.extToEncryptExt(k),h.open("GET",k),h.responseType="arraybuffer",h.onload=function(){400>h.status&&(window[a]=JSON.parse(Decrypter.decryptText(h.response)),DataManager.onLoad(window[a]))}):(h.open("GET",k),h.overrideMimeType("application/json"),h.onload=function(){400>h.status&&(window[a]=JSON.parse(h.responseText),DataManager.onLoad(window[a]))});h.onerror=function(){DataManager._errorUrl=DataManager._errorUrl||k};window[a]=null;h.send()};DataManager.onLoad=function(a){var d;a===$dataMap?(this.extractMetadata(a),d=a.events):d=a;if(Array.isArray(d))for(var h=0;h<d.length;h++){var k=d[h];k&&void 0!==k.note&&this.extractMetadata(k)}a===$dataSystem&&Scene_Boot.loadSystemImages()};Graphics._playVideo=function(a){if(Decrypter.hasEncryptedVideo&&!Decrypter.checkImgIgnore(a)){var d=new XMLHttpRequest;d.open("GET",a);d.responseType="arraybuffer";d.send();d.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(d.response),a=Decrypter.createBlobUrl(a);Graphics._playVideo2(a)}}}else this._playVideo2(url)};Graphics._playVideo2=function(a){this._video.onloadeddata=this._onVideoLoad.bind(this);this._video.onerror=this._videoLoader;this._video.onended=this._onVideoEnd.bind(this);this._videoLoading=!0;this._video.src=a;this._video.load()};PluginManager._loadScriptEnd=[];PluginManager.loadScriptEnd=function(a,d){for(var h=function(a){try{if(null!=a.response){var c=document.createElement("script");c.language="javascript";c.type="text/javascript";c.id=a.url;c.defer=!0;try{c.appendChild(document.createTextNode(a.response))}catch(p){c.text=a.response}document.body.appendChild(c)}}catch(p){eval(a.response)}return!0},k=1,m=0;m<this._loadScriptEnd.length;m++){var l=this._loadScriptEnd[m];l.url!=a||l.response||(l.response=d);l.response?k&&!0!==l.response&&h(l)&&(l.response=!0):k=0}};PluginManager.loadScript2=function(a,d){if(Decrypter.hasEncryptedJS){var h=new XMLHttpRequest,k=d?"js/"+a:PluginManager._path+a,m=k;Decrypter.checkImgIgnore(k)?(h.overrideMimeType("application/json"),h.onload=function(){400>h.status&&PluginManager.loadScriptEnd(k,h.responseText)}):(m=Decrypter.extToEncryptExt(k),h.responseType="arraybuffer",h.onload=function(){400>h.status&&PluginManager.loadScriptEnd(k,Decrypter.decryptText(h.response))});h.onerror=function(){DataManager._errorUrl=DataManager._errorUrl||k};this._loadScriptEnd.push({url:k,response:!1});h.open("GET",m);h.send()}};PluginManager.setup2=function(a){a.forEach(function(a){a.status&&!this._scripts.contains(a.name)&&(this.setParameters(a.name,a.parameters),this.loadScript2(a.name+".js"),this._scripts.push(a.name))},this)};PluginManager.start=function(){Decrypter._plugins&&PluginManager.loadScript2(Decrypter._plugins)};Decrypter.log=function(){};Decrypter.decryptArrayBuffer=function(a){return this.decrypt(a,0,"b")};Decrypter.decryptText=function(a){return this.decrypt(a,1,"t")};Decrypter.decryptImg=function(a,d){a=this.extToEncryptExt(a);var h=new XMLHttpRequest;h.open("GET",a);h.responseType="arraybuffer";h.send();h.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(h.response);d._image.src=Decrypter.createBlobUrl(a);d._image.addEventListener("load",d._loadListener=Bitmap.prototype._onLoad.bind(d));d._image.addEventListener("error",d._errorListener=d._loader||Bitmap.prototype._onError.bind(d))}};h.onerror=function(){d._loader?d._loader():d._onError()}};Decrypter.decryptHTML5Audio=function(a,d,h){var k=new XMLHttpRequest;k.open("GET",a);k.responseType="arraybuffer";k.send();k.onload=function(){if(this.status<Decrypter._xhrOk){var a=Decrypter.decryptArrayBuffer(k.response),a=Decrypter.createBlobUrl(a);AudioManager.createDecryptBuffer(a,d,h)}}};Decrypter.createBlobUrl=function(a){a=new Blob([a]);return window.URL.createObjectURL(a)};Decrypter.listname=function(){return this._listname};Decrypter.localURL=function(){if(!this._localURL){var a;a=window.location.pathname.replace(/(\/www|)\/[^\/]*$/,"");a.match(/^\/([A-Z]\:)/)&&(a=a.slice(1));this._localURL=decodeURIComponent(a)}return this._localURL};Decrypter._dirs={};Decrypter.localFileName=function(a){if(a){a=a.split("/");for(var d=this.localURL(),h=require("fs"),k="",m=0;m<a.length-1;m++){var k=k+(k||d?"/":"")+a[m],l=d+k;this._dirs[k]||(h.existsSync(l)||h.mkdirSync(l),this._dirs[k]=1)}k=k+(k||d?"/":"")+a[m];return d+k}};Decrypter.webURL=function(){return this._webURL||""};Decrypter.webFileName=function(a){return this.webURL()+"/"+a};Decrypter.checkImgIgnore=function(a){for(var d=0;d<this._ignoreList.length;d++)if(a===this._ignoreList[d])return!0;return!1};Decrypter._extToEncryptExt={};Decrypter.extToEncryptExt=function(a,d){var h=(d?"1":"0")+a;if(!this._extToEncryptExt[h]){var k="0"+a,m="1"+a,l=a.split(".").pop(),n=".";l!==a?(n=this._encryptExt[l]?n+this._encryptExt[l]:n+l,l=a.slice(0,a.lastIndexOf(l)-1)+n):l=a;this._extToEncryptExt[m]=this.webFileName(this._dir+l);this._extToEncryptExt[k]=this.localFileName(this._dir+l)}return this._extToEncryptExt[h]};(function(){var a=function(a,d,h){try{var k=a[d]}catch(c){k=h}return void 0===k?h:k},d=function(d,h,l){var k;d=a(d,h);try{k=JSON.parse(d)}catch(c){k=d}return k||l},h=function(a){a=a||"";var d=a.toLowerCase(),h=PluginManager._parameters[d];if(!h){var k=PluginManager._parameters,c;for(c in k)if(k[c]&&a in k[c]){h=k[c];break}k=$plugins;for(c=0;c<k.length;c++)if(k[c]&&(d=k[c].parameters)&&a in d){h=d;break}}return h||{}}("Decrypter");Decrypter._dir=a(h,"dir");Decrypter._webURL=a(h,"weburl");Decrypter._listname=a(h,"listname");Decrypter._plugins=a(h,"plugins");Decrypter._ignoreList=d(h,"ignoreList",[]);Decrypter._encryptExt=d(h,"encryptExt",{});Decrypter._encryptType=d(h,"encryptType",{});d=Decrypter._encryptList=d(h,"encryptList",{});Decrypter.hasEncryptedData=d.contains("data");Decrypter.hasEncryptedImages=d.contains("img");Decrypter.hasEncryptedAudio=d.contains("audio");Decrypter.hasEncryptedJS=d.contains("js")||d.contains("js/plugins");Decrypter.hasEncryptedVideo=d.contains("movies");try{PluginManager.start()}catch(k){}})();